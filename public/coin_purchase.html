<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UZB SMP | Coin sotib olish</title>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
    <div class="header">
      <div class="userinfo">
        <span>ᴜꜱᴇʀ: <strong class="username"></strong></span>
        <div id="coinr" class="coin-box">
          <img src="gold.webp" class="coin-icon" alt="Coins">
          <strong id="coins"></strong>

        </div>
        <button id="logoutr" class="logout" onclick="logout()"><img class="exit" src="logout.png" alt=""></button>

      </div>
      <div class="navbar">
        <a href="games.html">ɢᴀᴍᴇꜱ</a>
        <a href="home.html">ʜᴏᴍᴇ</a>
        <a href="buytoken.html">ᴛʀᴀᴅɪɴɢ</a>
        <a href="rank.html">ʀᴀɴᴋ</a>
        <a href="shop.html">ꜱʜᴏᴘ</a>
        <a href="event.html">ᴇᴠᴇɴᴛ</a>
        <a href="leaderboard.html">ʟᴇᴀᴅᴇʀʙᴏᴀʀᴅ</a>
        <a href="coin_purchase.html">ᴄᴏɪɴ</a>
        <button id="dfn" class="logout" onclick="logout()">ᴄʜɪǫɪꜱʜ</button>
      </div>
      <div class="user-info">
        <div id="coinboxremove" class="coin-box">
          <img src="gold.webp" class="coin-icon" alt="Coins">
          <strong id="coins2"></strong>

        </div>

      </div>
    </div>
        <div id="toast-container"></div>

        <div class="coin-purchase-box">
            <h2>Coin sotib olish</h2>
            <div class="coin-info-box">
                <p class="coin-buy-text">Coin sotib olishni istasangiz "sotib olish" tugmasini bosing va admin ga
                    kerakli coin miqdorini yozing admin carta raqamni aytadi va to'lovni amalga oshirasiz. <br><br>
                    (Rankniham hoddi shu usulda)</p>
            </div>
            <a href="https://t.me/ikromjon_0055" target="_blank">
                <button class="purchase-btn" onclick="purchaseCoins()">Sotib olish</button>
            </a>
            <div class="coin-amount-box">
                <h2 class="min-amount">minimum miqdor: 5k</h2>
                <h2 class="max-amount">maximal miqdor: 10M</h2>


                <h2 class="coin-price">Coin narxi: 5k coin = 2 000 so'm</h2>

            </div>

            <div class="coin-calculator">
                <h3>Coin narxini hisoblash</h3>
                <input type="number" id="coinInput" placeholder="Coin miqdorini kiriting">
                <button class="calculate-btn" onclick="calculatePrice()">Hisoblash</button>
                <p id="coinPriceResult"></p>
            </div>
            <h1>Promokod</h1>
            <div class="chiziq"></div>
            <input class="promo-input" type="text" id="promoInput" placeholder="Promokodni kiriting">
            <button class="promo-btn" onclick="redeemCode()">Redeem</button>
            <p>promokodlardan habardor bo'lib turmoqchimisiz? <a href="https://t.me/uzbeksmp" target="_blank">telegram</a><br>kanaldan habardor bo'lib turing</p>


            <p id="purchase-result"></p>
        </div>
        <script src="script.js"></script>

        <script>
            // Coin narxi formulasi, masalan 5k coin = 2000 so'm
            const baseCoin = 5000;
            const basePrice = 2000; // 5000 coin uchun narx

            function calculatePrice() {
                const coinAmount = document.getElementById("coinInput").value;
                const price = (coinAmount / baseCoin) * basePrice;
                if (coinAmount < 5000) {
                    document.getElementById("coinPriceResult").innerText = "Minimum miqdor 5k coin";
                } else if (coinAmount > 10000000) {
                    document.getElementById("coinPriceResult").innerText = "Maximum miqdor 10M coin";
                } else {
                    document.getElementById("coinPriceResult").innerText = `${coinAmount} coin = ${price.toLocaleString()} so'm`;
                }
            }

 function formatCoins(amount) {
  amount = Number(amount);
  if (isNaN(amount)) return "0";

  amount = Math.floor(amount); // faqat butun qism

  if (amount >= 1000000) {
    let formatted = Math.floor(amount / 1000000);
    return formatted + "M";
  } else if (amount >= 1000) {
    let formatted = Math.floor(amount / 1000);
    return formatted + "k";
  } else {
    return amount.toString();
  }
}

            function calculatePrice() {
                const coinAmount = parseInt(document.getElementById("coinInput").value);
                const price = (coinAmount / baseCoin) * basePrice;

                if (coinAmount < 5000) {
                    document.getElementById("coinPriceResult").innerText = "Minimum miqdor 5k coin";
                } else if (coinAmount > 10000000) {
                    document.getElementById("coinPriceResult").innerText = "Maximum miqdor 10M coin";
                } else {
                    document.getElementById("coinPriceResult").innerText = `${formatCoins(coinAmount)} coin = ${price.toLocaleString()} so'm`;
                }
            }
            async function redeemCode() {
                const code = document.getElementById('promoInput').value;
                const token = localStorage.getItem('token'); // login token

                if (!code) return alert("Promokod kiriting");

                try {
                    const res = await fetch('https://uzbsmpback.onrender.com/redeem', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token
                        },
                        body: JSON.stringify({ code })
                    });

                    const data = await res.json();

                    if (data.success) alert(data.message);
                    else alert(data.message);
                } catch (err) {
                    console.error(err);
                    alert("Server bilan bog‘lanishda xatolik yuz berdi");
                }
            }
            // Toast xabar funksiyasi
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                toast.innerText = message;

                toastContainer.appendChild(toast);

                // 3.5 soniya keyin o'chirish
                setTimeout(() => {
                    toast.remove();
                }, 3500);
            }

            // Redeem funksiyasi
            async function redeemCode() {
                const code = document.getElementById('promoInput').value;
                const token = localStorage.getItem('token'); // login token

                if (!code) {
                    showToast("Promokod kiriting", "error");
                    return;
                }

                try {
                    const res = await fetch('https://uzbsmpback.onrender.com/redeem', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token
                        },
                        body: JSON.stringify({ code })
                    });

                    const data = await res.json();

                    if (data.success) showToast(data.message, "success");
                    else showToast(data.message, "error");
                } catch (err) {
                    console.error(err);
                    showToast("Server bilan bog‘lanishda xatolik yuz berdi", "error");
                }
            }

        </script>
    </div>
</body>

</html>
